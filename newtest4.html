<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XYZ Gaming Support Dashboard</title>
<link rel="stylesheet" href="newtest4.css">
</head>
<body>
<audio id="pingSound" src="ping.mp3" preload="auto"></audio>
<div class="header"><h1>🎮 XYZ Gaming Support Dashboard</h1></div>
<div class="nav"><div class="nav-tabs">
<div class="nav-tab active" data-tab="dashboard">Dashboard</div>
<div class="nav-tab" data-tab="promotions">Promotions</div>
<div class="nav-tab" data-tab="livechat">Live Chat
  <span id="supportPingBadge" style="display:none;margin-left:6px;background:#ef4444;color:#fff;border-radius:9999px;padding:0 6px;font-size:12px;line-height:18px;vertical-align:middle;">0</span>
</div>
<div class="nav-tab" data-tab="settings">Settings</div>
</div></div>
<div class="main-content">
<div id="dashboard" class="tab-content active">
<div class="grid grid-3">
<div class="stat-card"><div class="stat-number" id="activeUsers">61</div><div class="stat-label">Active Users</div></div>
<div class="stat-card"><div class="stat-number" id="openTickets">0</div><div class="stat-label">Open Tickets</div></div>
<div class="stat-card"><div class="stat-number" id="promotionsCount">3</div><div class="stat-label">Promotions</div></div>
</div>
<div class="grid grid-2">
<div class="card"><div class="card-header">Recent Activity</div>
<div class="card-body">
<div style="color:#64748b;font-size:0.9rem" id="recentActivity">
<div style="margin-bottom:0.5rem">• Loading recent activity...</div>
</div></div></div>
<div class="card"><div class="card-header">Quick Actions</div>
<div class="card-body">
<div style="display:flex;flex-direction:column;gap:1rem">
<button class="btn" onclick="switchTab('promotions')">🎁 Manage Promotions</button>
<button class="btn btn-success" onclick="switchTab('livechat')">💬 View Live Chat</button>
<button class="btn btn-outline" onclick="refreshTickets()">🔄 Refresh Tickets</button>
</div></div></div>
</div></div>
<div id="promotions" class="tab-content">
<div class="grid grid-2">
<div class="card"><div class="card-header">Add New Promotion</div>
<div class="card-body">
<div class="form-group"><label for="promoTitle">Promotion Title *</label><input type="text" id="promoTitle" placeholder="Weekend Bonus" required></div>
<div class="form-group"><label for="promoDescription">Description *</label><textarea id="promoDescription" rows="2" placeholder="Get 25% bonus on all deposits this weekend" required></textarea></div>
<div class="form-group"><label for="promoDiscount">Discount (%) *</label><input type="number" id="promoDiscount" placeholder="25" min="0" max="100" required></div>
<div class="form-group"><label for="promoCode">Promo Code (Optional)</label><input type="text" id="promoCode" placeholder="WEEKEND25"></div>

<div class="form-group">
    <label>Time Limit</label>
    <div style="display: flex; gap: 10px; margin-top: 5px;">
        <div style="flex: 1;">
            <label style="display: block; font-size: 0.8em; color: #666;">Days</label>
            <input type="number" id="timeLimitDays" min="1" value="1" class="time-input">
        </div>
        <div style="flex: 1; display:none;">
            <label style="display: block; font-size: 0.8em; color: #666;">Hours</label>
            <input type="number" id="timeLimitHours" min="0" max="23" value="0" class="time-input" disabled>
        </div>
        <div style="flex: 1; display:none;">
            <label style="display: block; font-size: 0.8em; color: #666;">Minutes</label>
            <input type="number" id="timeLimitMins" min="0" max="59" value="0" class="time-input" disabled>
        </div>
    </div>
</div>

<div class="form-group">
    <label for="promoEndDate">End Date</label>
    <input type="date" id="promoEndDate">
    <small style="display:block;color:#666;margin-top:4px;">Promo ends at 23:59 on the selected date</small>
</div>

<div class="form-group">
    <label for="promoTerms">Terms & Conditions</label>
    <small style="display: block; color: #666; margin-bottom: 5px;">(Displayed when users ask "TOS" or "terms")</small>
    <textarea id="promoTerms" rows="2" placeholder="1. Valid for new users only\n2. Minimum deposit required"></textarea>
</div>

<div class="form-group">
    <label for="eligibleItems">Eligible Items/Games</label>
    <small style="display: block; color: #666; margin-bottom: 5px;">(Displayed when users ask "what's included" or "eligible items")</small>
    <input type="text" id="eligibleItems" placeholder="All games, Slots, Blackjack">
</div>
<button class="btn" onclick="addPromotion()">Add Promotion</button>
</div></div>
<div class="card"><div class="card-header">Bot Response Preview</div>
<div class="card-body"><div class="preview-box" id="botResponse">🎁 Available Promotions:

1. Welcome Bonus
   Get 10% off on your first deposit
   💰 10% off at xyz.com
   🎫 Code: WELCOME10

2. Weekend Special
   25% bonus on weekend deposits
   💰 25% off at xyz.com
   🎫 Code: WEEKEND25

3. VIP Bonus
   Exclusive 50% bonus for VIP members
   💰 50% off at xyz.com
   🎫 Code: VIP50</div></div></div>
</div>
<div class="card"><div class="card-header">Current Promotions</div>
<div class="card-body" style="padding:0"><div id="promotionsList">
<div class="promotion-item"><div class="promotion-info">
<h3>Welcome Bonus</h3><p>Get 10% off on your first deposit</p><p><strong>10% off at xyz.com</strong></p><p>Code: <span class="promotion-code">WELCOME10</span></p>
</div><div><button class="btn btn-danger" onclick="deletePromotion(1)">Delete</button></div></div>
<div class="promotion-item"><div class="promotion-info">
<h3>Weekend Special</h3><p>25% bonus on weekend deposits</p><p><strong>25% off at xyz.com</strong></p><p>Code: <span class="promotion-code">WEEKEND25</span></p>
</div><div><button class="btn btn-danger" onclick="deletePromotion(2)">Delete</button></div></div>
<div class="promotion-item"><div class="promotion-info">
<h3>VIP Bonus</h3><p>Exclusive 50% bonus for VIP members</p><p><strong>50% off at xyz.com</strong></p><p>Code: <span class="promotion-code">VIP50</span></p>
</div><div><button class="btn btn-danger" onclick="deletePromotion(3)">Delete</button></div></div>
</div></div></div></div>
<div id="livechat" class="tab-content">
<div class="grid grid-3">
<!-- Chat List Panel -->
<div class="card" style="grid-column: 1;">
    <div class="card-header">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <span>💬 Active Chats</span>
            <button class="btn btn-outline" style="padding:0.5rem 1rem;font-size:0.9rem" onclick="refreshTickets()">🔄 Refresh</button>
        </div>
    </div>
    <div class="card-body" style="padding:0;max-height:600px;overflow-y:auto">
        <div id="ticketsList">
            <div style="padding:2rem;text-align:center;color:#64748b">
                <div>🔄 Loading chats...</div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Messages Panel -->
<div class="card" style="grid-column: 2 / span 2;">
    <div class="card-header">this
        <div style="display:flex;justify-content:space-between;align-items:center">
            <span>💬 Chat #<span id="currentTicketId">-</span> <span id="chatStatus" style="font-size:0.9rem;color:#64748b"></span></span>
            <div style="display:flex;gap:0.5rem">
                <button class="btn btn-outline" onclick="loadChatHistory()" id="loadHistoryBtn" style="display:none">📜 Load History</button>
                <button class="btn btn-outline" onclick="assignTicket(selectedTicketId)" id="assignBtn" style="display:none">👤 Assign</button>
                <button class="btn btn-success" onclick="resolveTicket(selectedTicketId)" id="resolveBtn" style="display:none">✅ Resolve</button>
                <button class="btn btn-outline" onclick="debugChat()" style="font-size:0.8rem">🐛 Debug</button>
            </div>
        </div>
    </div>
    <div class="card-body" style="padding:0">
        <div class="chat-container" style="height:500px">
            <div class="chat-messages" id="chatMessages">
                <div style="text-align:center;color:#64748b;padding:2rem">
                    <div style="font-size:1.2rem;margin-bottom:1rem">👋 Welcome to Live Chat</div>
                    <div>Select a chat from the left panel to start messaging</div>
                </div>
            </div>
            <div class="chat-input-container" id="chatInputContainer" style="display:none">
                <div class="chat-input">
                    <input type="text" id="replyMessage" placeholder="Type your reply..." onkeypress="handleKeyPress(event)">
                    <button class="btn" onclick="sendReply()">Send</button>
                </div>
                <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #e2e8f0">
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                        <button class="btn btn-outline" onclick="useTemplate('deposit')">💰 Deposit Help</button>
                        <button class="btn btn-outline" onclick="useTemplate('password')">🔑 Password Reset</button>
                        <button class="btn btn-outline" onclick="useTemplate('promo')">🎁 Promo Code Help</button>
                        <button class="btn btn-outline" onclick="useTemplate('withdraw')">💸 Withdrawal Help</button>
                        <button class="btn btn-outline" onclick="useTemplate('welcome')">👋 Welcome</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>
<div id="settings" class="tab-content">
  <div class="card" style="max-width:600px;margin:2rem auto;">
    <div class="card-header">Edit Site Settings</div>
    <div class="card-body">
      <form id="settingsForm" onsubmit="saveSettings(event)">
        <div class="form-group">
          <label for="brandName">Brand/Site Name</label>
          <input type="text" id="brandName" name="brandName" required>
        </div>
        <div class="form-group">
          <label for="welcomeMessage">Welcome Message</label>
          <textarea id="welcomeMessage" name="welcomeMessage" rows="2" required></textarea>
        </div>
        <div class="form-group">
          <label for="waitMessage">Wait Message</label>
          <textarea id="waitMessage" name="waitMessage" rows="2" required></textarea>
        </div>
        <div class="form-group">
          <label for="endMessage">Ending Message</label>
          <textarea id="endMessage" name="endMessage" rows="2" required></textarea>
        </div>
        <button class="btn btn-success" type="submit">Save Settings</button>
      </form>
      <div id="settingsStatus" style="margin-top:1rem;"></div>

      <hr style="border:none;border-top:1px solid #e2e8f0;margin:1.5rem 0;">
      <div>
        <div style="font-weight:600;margin-bottom:0.5rem">RTP Link</div>
        <div class="form-group">
          <label for="rtpLinkInput">Current RTP URL</label>
          <input type="url" id="rtpLinkInput" placeholder="https://your-rtp-link.example/rtp" required>
        </div>
        <button class="btn" onclick="saveRtpLink()">Save RTP Link</button>
        <div id="rtpStatus" style="margin-top:0.5rem;color:#64748b"></div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
// LiveChat API Configuration
const ACCESS_TOKEN = 'NzdiZGVmYjAtMWI2Mi00ZjllLTg1YWItYjczNzJjYTk1N2Y2OnVzLXNvdXRoMTpVLU1JbElnT0tiSEhuWldwN1E5YXFQaFR0VlU='

let currentTickets = [];
let selectedTicketId = null;
let chatHistory = new Map(); // Store chat history for each ticket
let chatDetails = new Map(); // Store chat details for each ticket

// Promotions data
// Remove local promotions array
// let promotions = ...

// Fetch promotions from backend and update UI
async function fetchPromotions() {
    try {
    const res = await fetch('/promotions');
        const data = await res.json();
        if (data.success) {
            window.promotions = data.promotions;
            updatePromotionsUI();
        }
    } catch (e) {
        window.promotions = [];
        updatePromotionsUI();
    }
}

// Update all UI elements that show promotions
function updatePromotionsUI() {
    // Update promotions count in the dashboard
    if (window.promotions) {
        document.getElementById('promotionsCount').textContent = window.promotions.length || 0;
    }
    
    // Update bot response preview
    updateBotResponse();
    // Update promotions list
    const list = document.getElementById('promotionsList');
    if (!window.promotions || window.promotions.length === 0) {
        list.innerHTML = '<div style="padding:1rem">No promotions available.</div>';
        // Update dashboard count
        const countEl = document.getElementById('promotionsCount');
        if (countEl) countEl.textContent = '0';
        return;
    }
    list.innerHTML = window.promotions.map(p => {
        const endStr = p.endDate ? new Date(p.endDate).toLocaleDateString() : '';
        const eligArr = p.eligibleItems && p.eligibleItems.length ? p.eligibleItems : (p.eligibleGames || []);
        const eligStr = Array.isArray(eligArr) ? eligArr.join(', ') : '';
        const termsStr = p.terms || '';
        return `
        <div class="promotion-item">
          <div class="promotion-info">
            <h3>${p.title}</h3>
            <p>${p.description}</p>
            <p><strong>${p.discount}% off at xyz.com</strong></p>
            ${p.code ? `<p>Code: <span class="promotion-code">${p.code}</span></p>` : ''}
            ${endStr ? `<p>📅 Ends: ${endStr}</p>` : ''}
            ${eligStr ? `<p>✅ Eligible: ${eligStr}</p>` : ''}
            ${termsStr ? `<p>📜 Terms: ${termsStr}</p>` : ''}
          </div>
          <div><button class="btn btn-danger" onclick="deletePromotion(${p.id})">Delete</button></div>
        </div>`;
    }).join('');
    // Update dashboard count
    const countEl = document.getElementById('promotionsCount');
    if (countEl) countEl.textContent = String(window.promotions.length);
}

// Add promotion via backend
async function addPromotion() {
    const t = document.getElementById('promoTitle').value.trim(),
          d = document.getElementById('promoDescription').value.trim(),
          disc = document.getElementById('promoDiscount').value,
          c = document.getElementById('promoCode').value.trim();
    const days = Number(document.getElementById('timeLimitDays').value || 1);
    const hours = 0; // fixed to 0 per 1-day-only preference
    const mins = 0;  // fixed to 0 per 1-day-only preference
    const terms = document.getElementById('promoTerms').value.trim();
    const eligible = document.getElementById('eligibleItems').value.trim();
    const endDate = document.getElementById('promoEndDate').value; // YYYY-MM-DD
    if (!t || !d || !disc) {
        alert('Please fill in Title, Description, and Discount fields');
        return;
    }
    try {
        const payload = {
            title: t,
            description: d,
            discount: disc,
            code: c,
            // Only send timeLimit if any unit > 0
            timeLimit: (days || hours || mins) ? { days, hours, minutes: mins } : null,
            terms: terms || null,
            eligibleItems: eligible || null,
            endDate: endDate || null
        };
    const res = await fetch('/promotions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('promoTitle').value = '';
            document.getElementById('promoDescription').value = '';
            document.getElementById('promoDiscount').value = '';
            document.getElementById('promoCode').value = '';
            // Keep default 1 day; do not reset to 0
            document.getElementById('promoTerms').value = '';
            document.getElementById('eligibleItems').value = '';
            document.getElementById('promoEndDate').value = '';
            await fetchPromotions();
            alert('Promotion added successfully!');
        } else {
            alert('Failed to add promotion: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Failed to add promotion: ' + e.message);
    }
}

// Delete promotion via backend
async function deletePromotion(id) {
    if (!confirm('Delete this promotion?')) return;
    try {
    const res = await fetch(`/promotions/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            await fetchPromotions();
            alert('Promotion deleted successfully!');
        } else {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Failed to delete: ' + e.message);
    }
}

// Update bot response preview to use window.promotions
function updateBotResponse() {
    const r = document.getElementById('botResponse');
    if (!window.promotions || !window.promotions.length) {
        r.textContent = "No promotions available at the moment.";
        return;
    }
    let response = "🎁 Available Promotions:\n\n";
    window.promotions.forEach((p, i) => {
        response += `${i+1}. ${p.title}\n   ${p.description}\n   💰 ${p.discount}% off at xyz.com\n`;
        if (p.code) response += `   🎫 Code: ${p.code}\n`;
        response += '\n';
    });
    r.textContent = response;
}

let templates={deposit:"Hi! I understand you're having trouble with your deposit. Let me check your account status. Please provide your user ID and the transaction reference number so I can assist you better.",password:"I'll help you reset your password. Please check your spam folder first, then I'll send you a new reset link to your registered email address.",promo:"I see you're having trouble with a promo code. Let me help you with that. Please make sure you're entering the code exactly as shown and that it hasn't expired."};

// Tab switching
function switchTab(t){
    document.querySelectorAll('.nav-tab').forEach(tab=>tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content=>content.classList.remove('active'));
    document.querySelector(`[data-tab="${t}"]`).classList.add('active');
    document.getElementById(t).classList.add('active');
    
    // Auto-refresh tickets when switching to livechat tab
    if (t === 'livechat') {
        refreshTickets();
    }
    // Refresh promotions when switching to promotions tab
    if (t === 'promotions') {
        fetchPromotions();
    }
}

// LiveChat API Functions
// Enhanced getActiveChats with better error handling and debugging
async function getActiveChats() {
    try {
        console.log('🔄 Fetching active chats...');
        const response = await fetch('https://api.livechatinc.com/v3.5/agent/action/list_chats', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${ACCESS_TOKEN}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                filters: {
                    status: ['active', 'queued', 'pending']
                },
                limit: 20
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ API Error Response:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('📋 Full API Response:', JSON.stringify(data, null, 2));

        // Handle different possible response structures
        let chats = data?.chats || data?.data?.chats || data?.chats_summary || data;

        // If chats is an object, convert to array
        if (chats && !Array.isArray(chats)) {
            chats = Object.values(chats);
        }

        if (!Array.isArray(chats)) {
            console.log('⚠️ No valid chats array found in response');
            return [];
        }

        // Filter out archived chats
        const activeChats = chats.filter(chat => {
            const status = chat.status || chat.chat?.status;
            return status !== 'archived' && status !== 'closed';
        });

        console.log(`✅ Found ${activeChats.length} active chats (filtered from ${chats.length} total)`);
        return activeChats;
    } catch (error) {
        console.error('❌ Failed to get chats:', error);
        return [];
    }
}

async function getLatestCustomerMessage(chatId) {
    try {
        console.log(`🔄 Fetching messages for chat ${chatId}...`);
        const response = await fetch('https://api.livechatinc.com/v3.5/agent/action/list_threads', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${ACCESS_TOKEN}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ chat_id: chatId })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`❌ Error response for chat ${chatId}:`, errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(`📋 Threads response for chat ${chatId}:`, JSON.stringify(data, null, 2));

        const allEvents = (data.threads || []).flatMap(thread => thread.events || []);
        console.log(`📝 Found ${allEvents.length} total events for chat ${chatId}`);
        
        const customerMessages = allEvents
            .filter(event => event.type === 'message' && event.text && event.author_id && 
                           !event.author_id.includes('agent') && !event.author_id.includes('bot'))
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        console.log(`👤 Found ${customerMessages.length} customer messages for chat ${chatId}`);
        
        if (customerMessages.length > 0) {
            console.log(`📨 Latest message: "${customerMessages[0].text.substring(0, 50)}..."`);
        }

        return customerMessages.length > 0 ? customerMessages[0] : null;
        
    } catch (error) {
        console.error(`❌ Error getting messages for ${chatId}:`, error);
        return null;
    }
}

// Get detailed information about a chat
async function getChatDetails(chatId) {
    try {
        console.log(`🔄 Fetching chat details for ${chatId}...`);
        const response = await fetch('https://api.livechatinc.com/v3.5/agent/action/get_chat', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${ACCESS_TOKEN}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ chat_id: chatId })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`❌ Error response for chat details ${chatId}:`, errorText);
            return null;
        }

        const data = await response.json();
        console.log(`📋 Chat details for ${chatId}:`, JSON.stringify(data, null, 2));
        
        // Check if chat is archived
        const status = data?.chat?.status || data?.status;
        if (status === 'archived' || status === 'closed') {
            console.log(`📁 Chat ${chatId} is archived/closed, skipping...`);
            return null;
        }
        
        // Store chat details
        chatDetails.set(chatId, data);
        return data;
        
    } catch (error) {
        console.error(`❌ Error getting chat details for ${chatId}:`, error);
        return null;
    }
}

// Enhanced sendMessage with fallback logic and auto-resume
async function sendMessage(chatId, message) {
    // Try Basic first
    let response, error;
    try {
        response = await fetch('https://api.livechatinc.com/v3.5/agent/action/send_event', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${ACCESS_TOKEN}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                chat_id: chatId,
                event: {
                    type: 'message',
                    text: message,
                    recipients: 'all'
                }
            })
        });
        if (response.ok) return true;
        error = await response.json();
        // If requester is not user of the chat, try to resume the chat
        if (error.error && error.error.message && error.error.message.includes('Requester is not user of the chat')) {
            const resumed = await tryResumeChat(chatId);
            if (resumed) {
                // Try sending again after resume
                response = await fetch('https://api.livechatinc.com/v3.5/agent/action/send_event', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        event: {
                            type: 'message',
                            text: message,
                            recipients: 'all'
                        }
                    })
                });
                if (response.ok) return true;
                error = await response.json();
            }
        }
        if (response.status === 401) throw new Error('basic_auth_failed');
        throw new Error(error.error?.message || 'Failed to send message');
    } catch (err) {
        // Try Bearer if Basic fails
        if (err.message === 'basic_auth_failed') {
            try {
                response = await fetch('https://api.livechatinc.com/v3.5/agent/action/send_event', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        event: {
                            type: 'message',
                            text: message,
                            recipients: 'all'
                        }
                    })
                });
                if (response.ok) return true;
                error = await response.json();
                throw new Error(error.error?.message || 'Failed to send message with Bearer');
            } catch (bearerErr) {
                // Try v3.4 as last resort
                try {
                    response = await fetch('https://api.livechatinc.com/v3.4/agent/action/send_event', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Basic ${ACCESS_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            event: {
                                type: 'message',
                                text: message
                            }
                        })
                    });
                    if (response.ok) return true;
                    error = await response.json();
                    throw new Error(error.error?.message || 'Failed to send message with v3.4');
                } catch (v34Err) {
                    showStatusMessage('❌ All attempts to send message failed: ' + (v34Err.message || 'Unknown error'), 'error');
                    return false;
                }
            }
        } else {
            // User-friendly error for requester not user
            if (err.message && err.message.includes('Requester is not user of the chat')) {
                showStatusMessage('❌ You must join or be assigned to this chat before sending a message. Please assign yourself or ask an admin.', 'error');
            } else {
                showStatusMessage('❌ Failed to send message: ' + (err.message || 'Unknown error'), 'error');
            }
            return false;
        }
    }
    return false;
}

// Try to resume/join the chat
async function tryResumeChat(chatId) {
    try {
        const response = await fetch('https://api.livechatinc.com/v3.5/agent/action/resume_chat', {
            method: 'POST',
            headers: {
                'Authorization': `Basic ${ACCESS_TOKEN}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                chat: { id: chatId },
                active: true
            })
        });
        return response.ok;
    } catch (e) {
        return false;
    }
}

// Show status message in chat
function showStatusMessage(msg, type) {
    const chatMessages = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-message ' + (type === 'error' ? 'support' : 'user');
    div.style.background = type === 'error' ? '#fee2e2' : '#d1fae5';
    div.style.color = type === 'error' ? '#dc2626' : '#065f46';
    div.innerHTML = `<div>${msg}</div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Ticket Management
async function refreshTickets() {
    const ticketsList = document.getElementById('ticketsList');
    ticketsList.innerHTML = '<div style="padding:2rem;text-align:center;color:#64748b"><div>🔄 Loading tickets...</div></div>';
    
    try {
        console.log('🔄 Starting ticket refresh...');
        const chats = await getActiveChats();
        console.log(`📋 Retrieved ${chats.length} total chats`);
        
        // Only show chats with an active thread
        const allChats = Array.isArray(chats) ? chats : [];
        const activeChats = allChats.filter(chat => 
            chat.last_thread_summary && chat.last_thread_summary.active
        );
        console.log(`📋 Using ${activeChats.length} active chats for ticket list`);
        
        currentTickets = [];
        
        if (activeChats.length === 0) {
            ticketsList.innerHTML = '<div style="padding:2rem;text-align:center;color:#64748b"><div>✅ No active chats found</div></div>';
            updateDashboardStats(0);
            return;
        }

        // Get latest message and details for each chat
        console.log('🔄 Fetching messages and details for each chat...');
        const ticketsWithMessages = await Promise.all(
            activeChats.map(async (chat) => {
                const latestMessage = await getLatestCustomerMessage(chat.id);
                const chatDetail = await getChatDetails(chat.id);
                return {
                    chat: chat,
                    latestMessage: latestMessage,
                    chatDetail: chatDetail
                };
            })
        );

        // Include all chats, even those without customer messages
        const validTickets = ticketsWithMessages.filter(ticket => ticket.chat);
        currentTickets = validTickets;

        console.log(`✅ Processing ${validTickets.length} tickets`);

        // Update tickets list
        if (validTickets.length === 0) {
            ticketsList.innerHTML = '<div style="padding:2rem;text-align:center;color:#64748b"><div>✅ No active chats found</div></div>';
        } else {
            ticketsList.innerHTML = validTickets.map((ticket, index) => {
                const chat = ticket.chat;
                const message = ticket.latestMessage;
                const chatDetail = ticket.chatDetail;
                const timeAgo = message ? getTimeAgo(new Date(message.created_at)) : 'No messages';
                const selected = (selectedTicketId === chat.id) ? 'selected' : '';
                const messageText = message ? message.text : 'No messages yet';
                
                // Get user information from chat details or message
                let userName = 'Unknown User';
                if (chatDetail && chatDetail.users && chatDetail.users.length > 0) {
                    const customer = chatDetail.users.find(user => !user.type || user.type === 'customer');
                    if (customer) {
                        userName = customer.name || customer.email || customer.id || 'Customer';
                    }
                } else if (message && message.author_id) {
                    userName = message.author_id;
                }
                
                // Show ticket code (chat ID) and user name
                return `
                <div class="ticket-item ${selected}" onclick="openChat('${chat.id}')" id="ticket-${chat.id}">
                    <div class="ticket-header">
                        <div>
                            <span class="ticket-id">Ticket: <b>${chat.id}</b></span>
                            <div class="ticket-user">@${userName} - ${timeAgo}</div>
                        </div>
                    </div>
                    <div class="ticket-message">${messageText}</div>
                </div>`;
            }).join('');
        }
        // Update open tickets count in the dashboard
        document.getElementById('openTickets').textContent = validTickets.length || 0;
        
        // Update dashboard with ticket count
        updateDashboardStats(validTickets.length);
        updateRecentActivity(validTickets);
        
    } catch (error) {
        console.error('❌ Error refreshing tickets:', error);
        ticketsList.innerHTML = '<div style="padding:2rem;text-align:center;color:#ef4444"><div>❌ Error loading tickets</div></div>';
    }
}

// Load full chat history for a ticket
async function loadChatHistory(chatId = selectedTicketId) {
    if (!chatId) return;
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '<div style="text-align:center;color:#64748b;padding:2rem">🔄 Loading chat history...</div>';
    try {
        console.log(`🔄 Loading chat history for ${chatId}...`);
        // Fetch chat details in parallel with threads
        const [threadsResponse, chatDetail] = await Promise.all([
            fetch('https://api.livechatinc.com/v3.5/agent/action/list_threads', {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${ACCESS_TOKEN}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ chat_id: chatId })
            }),
            getChatDetails(chatId)
        ]);
        if (!threadsResponse.ok) {
            const errorText = await threadsResponse.text();
            console.error(`❌ Error loading chat history for ${chatId}:`, errorText);
            throw new Error(`HTTP error! status: ${threadsResponse.status}`);
        }
        const data = await threadsResponse.json();
        console.log(`📋 Chat history response for ${chatId}:`, JSON.stringify(data, null, 2));
        const allEvents = (data.threads || []).flatMap(thread => thread.events || []);
        console.log(`📝 Found ${allEvents.length} events in chat history for ${chatId}`);
        // Store for later
        chatHistory.set(chatId, allEvents);
        // chatDetails is updated by getChatDetails
        renderChatMessages(allEvents);
    } catch (error) {
        console.error(`❌ Error loading chat history for ${chatId}:`, error);
        chatMessages.innerHTML = '<div style="text-align:center;color:#ef4444;padding:2rem">Error loading chat</div>';
    }
}

// Render all messages in chat
function renderChatMessages(events) {
    const chatMessages = document.getElementById('chatMessages');
    if (!events || events.length === 0) {
        chatMessages.innerHTML = '<div style="text-align:center;color:#64748b;padding:2rem">No messages found</div>';
        return;
    }
    
    // Get chat details for better user information
    const chatDetail = chatDetails.get(selectedTicketId);
    let hasNewSupportRequest = false;
    let supportRequestMessage = '';
    let messagesHTML = '';
    
    // Sort messages oldest to newest
    const sortedEvents = events
        .filter(e => e.type === 'message' && e.text)
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    
    // Process each message
    sortedEvents.forEach(event => {
        const isAgent = event.sender === 'agent' || event.author_type === 'agent';
        let author = 'Customer';
        
        // Get customer details if available
        if (!isAgent && chatDetail?.users?.length > 0) {
            const customer = chatDetail.users.find(user => !user.type || user.type === 'customer');
            if (customer) {
                author = customer.name || customer.email || customer.id || 'Customer';
            }
        }
        
        const time = event.created_at ? getTimeAgo(new Date(event.created_at)) : '';
        const isSupportRequest = isSupportRelatedMessage(event.text);
        const supportBadge = isSupportRequest ? 
            '<span class="support-badge" title="Support Request">🆘</span>' : '';
        
        // Check if this is a new support request that needs notification
        if (isSupportRequest && !isAgent && !event.processed) {
            hasNewSupportRequest = true;
            supportRequestMessage = event.text;
            event.processed = true; // Mark as processed to avoid duplicate notifications
        }
        
        // Build message HTML
        messagesHTML += `
            <div class="chat-message ${isAgent ? 'support' : 'user'} ${isSupportRequest ? 'support-request' : ''}">
                <div class="message-author">${isAgent ? 'Support' : '@'+author}</div>
                <div>${supportBadge} ${event.text}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
    });
    
    // Update chat messages
    chatMessages.innerHTML = messagesHTML;

    // Scroll to bottom and trigger notifications
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Trigger notification for new support requests
        if (hasNewSupportRequest) {
            playPing();
            showSupportPingToast(supportRequestMessage);
            updateSupportPingBadge(1);
        }
    }, 100);
}

function isSupportRelatedMessage(message) {
    if (!message) return false;
    const lowerMsg = message.toLowerCase();
    return (
        /\b(account|akun|profile|profil|withdraw|tarik|password|reset|verif|verification|kyc|help|bantuan|support|cs)\b/.test(lowerMsg) &&
        !/\b(deposit|top.?up|top.?in|saldo|balance|game|main|play|bonus|promo|promotion|voucher|kode|code|free|gratis|claim|klaim|bet|taruhan|menang|win|lose|kalah|draw|seri|live|casino|slot|poker|blackjack|roulette|baccarat|togel|toto|togel online|live casino|sportbook|sportsbook|sport|sports|bola|football|basket|basketball|tennis|badminton|hoki|parlay|mix parlay|asian handicap|1x2|over under|ou|odd even|tebak skor|correct score|cs|ht|ft|hdp|handicap|hdp|asian|corner|kartu|kartu merah|kartu kuning|penalty|free kick|goal|gol|score|skor|h2h|head to head|klasemen|standing|jadwal|schedule|hasil|result|statistik|statistic|prediksi|prediction|berita|news|update|info|information|bocoran|leak|prediksi parlay|parlay|mix parlay|parlay bca|parlay bri|parlay bni|parlay mandiri|parlay bsi|parlay bjb|parlay bni syariah|parlay bri syariah|parlay bsi syariah|parlay bjb syariah|parlay bca syariah|parlay bni 46|parlay bri 46|parlay bsi 46|parlay bjb 46|parlay bca 46|parlay bni 46 syariah|parlay bri 46 syariah|parlay bsi 46 syariah|parlay bjb 46 syariah|parlay bca 46 syariah)\b/.test(lowerMsg)
    );
}

function getTicketStatus(status) {
    switch (status) {
        case 'active': return { text: 'Active', class: 'urgent' };
        case 'queued': return { text: 'Queued', class: 'open' };
        case 'pending': return { text: 'Pending', class: 'assigned' };
        default: return { text: 'Open', class: 'open' };
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minutes ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    return `${diffDays} days ago`;
}

function updateDashboardStats(ticketCount) {
    document.getElementById('openTickets').textContent = ticketCount;
    // Always show 61 active users unless you want to simulate
    document.getElementById('activeUsers').textContent = 61;
    // Promotions count from backend
    document.getElementById('promotionsCount').textContent = (window.promotions && window.promotions.length) ? window.promotions.length : 3;
}

function updateRecentActivity(tickets) {
    const recentActivity = document.getElementById('recentActivity');
    const activities = tickets.slice(0, 4).map(ticket => {
        if (ticket.latestMessage) {
            const message = ticket.latestMessage.text.substring(0, 50) + (ticket.latestMessage.text.length > 50 ? '...' : '');
            
            // Get user information from chat details or message
            let userName = 'Unknown User';
            if (ticket.chatDetail && ticket.chatDetail.users && ticket.chatDetail.users.length > 0) {
                const customer = ticket.chatDetail.users.find(user => !user.type || user.type === 'customer');
                if (customer) {
                    userName = customer.name || customer.email || customer.id || 'Customer';
                }
            } else if (ticket.latestMessage && ticket.latestMessage.author_id) {
                userName = ticket.latestMessage.author_id;
            }
            
            return `• User @${userName} - ${message}`;
        } else {
            return `• Chat #${ticket.chat.id} - No messages yet`;
        }
    });
    
    if (activities.length === 0) {
        activities.push('• No recent activity');
    }
    
    recentActivity.innerHTML = activities.map(activity => 
        `<div style="margin-bottom:0.5rem">${activity}</div>`
    ).join('');
}

// Chat Functions
// Open a chat and load its history
async function openChat(chatId) {
    console.log(`🔄 Opening chat ${chatId}...`);
    selectedTicketId = chatId;
    document.getElementById('currentTicketId').textContent = chatId;
    
    // Highlight selected ticket
    document.querySelectorAll('.ticket-item').forEach(el => el.classList.remove('selected'));
    const selectedEl = document.getElementById('ticket-' + chatId);
    if (selectedEl) selectedEl.classList.add('selected');
    
    // Find chat status and user info
    const ticket = currentTickets.find(t => t.chat.id === chatId);
    const chatStatus = ticket ? ticket.chat.status : 'unknown';
    const statusObj = getTicketStatus(chatStatus);
    
    // Get user information for chat header
    let userName = 'Unknown User';
    if (ticket && ticket.chatDetail && ticket.chatDetail.users && ticket.chatDetail.users.length > 0) {
        const customer = ticket.chatDetail.users.find(user => !user.type || user.type === 'customer');
        if (customer) {
            userName = customer.name || customer.email || customer.id || 'Customer';
        }
    }
    
    document.getElementById('chatStatus').textContent = `(${statusObj.text}) - @${userName}`;
    document.getElementById('chatInputContainer').style.display = '';
    
    // Load chat history
    await loadChatHistory(chatId);
}

// Implement sendReply to simulate sending to test.js:
function playPing() {
    const audio = document.getElementById('pingSound');
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}

// Fast sendReply implementation for instant UI feedback
function sendReply() {
    const input = document.getElementById('replyMessage');
    const message = input.value.trim();
    if (!message || !selectedTicketId) return;
    // Optimistically add the message to the chat UI
    const chatMessages = document.getElementById('chatMessages');
    const now = new Date();
    const tempId = 'temp-' + now.getTime();
    const tempMsgHtml = `<div class=\"chat-message agent\" id=\"${tempId}\" style=\"opacity:0.6\">You: ${message} <span style='font-size:0.8em;color:#64748b'>(sending...)</span></div>`;
    chatMessages.innerHTML += tempMsgHtml;
    chatMessages.scrollTop = chatMessages.scrollHeight;
    input.value = '';
    input.focus();
    if (typeof playPing === 'function') playPing();
    // Send the message in the background
    sendMessage(selectedTicketId, message).then(success => {
        const tempMsg = document.getElementById(tempId);
        if (success) {
            if (tempMsg) tempMsg.outerHTML = `<div class='chat-message agent'>You: ${message}</div>`;
            // Optionally, reload chat history for accuracy
            // loadChatHistory(selectedTicketId);
        } else {
            if (tempMsg) tempMsg.outerHTML = `<div class='chat-message agent' style='color:#ef4444'>You: ${message} <span style='font-size:0.8em'>(failed)</span></div>`;
        }
    });
}

// Remove or disable sendMessage function
// Remove or disable sendReply function
// Remove or disable chat input UI

// Template Functions
function useTemplate(t) {
    document.getElementById('replyMessage').value = templates[t];
}

function handleKeyPress(e) {
    if (e.key === 'Enter') sendReply();
}

function assignTicket(id) {
    alert(`Ticket #${id} assigned to you!`);
}

function resolveTicket(id) {
    if (confirm(`Mark ticket #${id} as resolved?`)) {
        alert(`Ticket #${id} resolved successfully!`);
        refreshTickets(); // Refresh the list
    }
}

// Debug function to help troubleshoot API issues
function debugChat() {
    console.log('🐛 Debug Information:');
    console.log('Selected Ticket ID:', selectedTicketId);
    console.log('Current Tickets:', currentTickets);
    console.log('Chat History:', chatHistory);
    console.log('Chat Details:', chatDetails);
    
    if (selectedTicketId) {
        const ticket = currentTickets.find(t => t.chat.id === selectedTicketId);
        console.log('Selected Ticket:', ticket);
        
        if (ticket) {
            console.log('Chat Object:', ticket.chat);
            console.log('Latest Message:', ticket.latestMessage);
            console.log('Chat Detail:', ticket.chatDetail);
        }
    }
    
    alert('Debug information logged to console. Press F12 to view.');
}

// Promotion Functions
// Remove local promotions array
// let promotions = ...

// Fetch promotions from backend and update UI
async function fetchPromotions() {
    try {
        const res = await fetch('http://localhost:3001/promotions');
        const data = await res.json();
        if (data.success) {
            window.promotions = data.promotions;
            updatePromotionsUI();
        }
    } catch (e) {
        window.promotions = [];
        updatePromotionsUI();
    }
}

// Update all UI elements that show promotions
function updatePromotionsUI() {
    // Update promotions count in the dashboard
    if (window.promotions) {
        document.getElementById('promotionsCount').textContent = window.promotions.length || 0;
    }
    
    // Update bot response preview
    updateBotResponse();
    // Update promotions list
    const list = document.getElementById('promotionsList');
    if (!window.promotions || window.promotions.length === 0) {
        list.innerHTML = '<div style="padding:1rem">No promotions available.</div>';
        return;
    }
    
    list.innerHTML = window.promotions.map(p => {
        // Format time remaining if time limit is set
        let timeLimitHtml = '';
        if (p.timeLimit && p.timeLimit.totalMinutes > 0) {
            const days = Math.floor(p.timeLimit.totalMinutes / (24 * 60));
            const hours = Math.floor((p.timeLimit.totalMinutes % (24 * 60)) / 60);
            const mins = p.timeLimit.totalMinutes % 60;
            timeLimitHtml = `
                <div class="promo-detail">
                    <strong>⏰ Time Remaining:</strong> 
                    ${days > 0 ? `${days}d ` : ''}${hours > 0 || days > 0 ? `${hours}h ` : ''}${mins}m
                </div>`;
        }
        
        // Format eligible items if any
        let eligibleItemsHtml = '';
        if (p.eligibleItems && p.eligibleItems.length > 0) {
            eligibleItemsHtml = `
                <div class="promo-detail">
                    <strong>🎮 Eligible Items:</strong> 
                    ${p.eligibleItems.join(', ')}
                </div>`;
        }
        
        // Format terms if any
        let termsHtml = '';
        if (p.terms) {
            termsHtml = `
                <div class="promo-detail">
                    <strong>📝 Terms:</strong> 
                    <div style="margin-top:4px;color:#666;font-size:0.9em">${p.terms.replace(/\n/g, '<br>')}</div>
                </div>`;
        }
        
        return `
        <div class="promotion-item">
            <div class="promotion-info">
                <h3>${p.title}</h3>
                <p>${p.description}</p>
                <p><strong>${p.discount}% off at xyz.com</strong></p>
                <p>Code: <span class="promotion-code">${p.code || 'N/A'}</span></p>
                ${timeLimitHtml}
                ${eligibleItemsHtml}
                ${termsHtml}
            </div>
            <div>
                <button class="btn btn-danger" onclick="deletePromotion(${p.id})">Delete</button>
            </div>
        </div>`;
    }).join('');
}

// Add promotion via backend
async function addPromotion() {
    const t = document.getElementById('promoTitle').value.trim(),
          d = document.getElementById('promoDescription').value.trim(),
          disc = document.getElementById('promoDiscount').value,
          c = document.getElementById('promoCode').value.trim();
    if (!t || !d || !disc) {
        alert('Please fill in Title, Description, and Discount fields');
        return;
    }
    try {
        const res = await fetch('http://localhost:3001/promotions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: t, description: d, discount: disc, code: c })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('promoTitle').value = '';
            document.getElementById('promoDescription').value = '';
            document.getElementById('promoDiscount').value = '';
            document.getElementById('promoCode').value = '';
            await fetchPromotions();
            alert('Promotion added successfully!');
        } else {
            alert('Failed to add promotion: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Failed to add promotion: ' + e.message);
    }
}

 


    // LiveChat inline boot snippet removed here to avoid duplicates. See single widget at bottom of page.


// Delete promotion via backend
async function deletePromotion(id) {
    if (!confirm('Delete this promotion?')) return;
    try {
        const res = await fetch(`http://localhost:3001/promotions/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            await fetchPromotions();
            alert('Promotion deleted successfully!');
        } else {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Failed to delete: ' + e.message);
    }
}

// Update bot response preview to use window.promotions
function updateBotResponse() {
    const r = document.getElementById('botResponse');
    if (!window.promotions || !window.promotions.length) {
        r.textContent = "No promotions available at the moment.";
        return;
    }
    let response = "🎁 Available Promotions:\n\n";
    window.promotions.forEach((p, i) => {
        response += `${i+1}. ${p.title}\n   ${p.description}\n   💰 ${p.discount}% off at xyz.com\n`;
        if (p.code) response += `   🎫 Code: ${p.code}\n`;
        response += '\n';
    });
    r.textContent = response;
}

function loadSettings() {
    fetch('/settings')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('brandName').value = data.settings.brandName || '';
        document.getElementById('welcomeMessage').value = data.settings.welcomeMessage || '';
        document.getElementById('waitMessage').value = data.settings.waitMessage || '';
        document.getElementById('endMessage').value = data.settings.endMessage || '';
      }
    });
}
function saveSettings(e) {
  e.preventDefault();
  const settings = {
    brandName: document.getElementById('brandName').value,
    welcomeMessage: document.getElementById('welcomeMessage').value,
    waitMessage: document.getElementById('waitMessage').value,
    endMessage: document.getElementById('endMessage').value
  };
    fetch('/settings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  })
    .then(res => res.json())
    .then(data => {
      const status = document.getElementById('settingsStatus');
      if (data.success) {
        status.textContent = 'Settings saved!';
        status.style.color = '#16a34a';
      } else {
        status.textContent = 'Failed to save settings.';
        status.style.color = '#dc2626';
      }
    });
}

// RTP Management
async function loadRtpLink() {
  try {
    const res = await fetch('/api/rtp');
    const data = await res.json();
    if (data && data.success) {
      document.getElementById('rtpLinkInput').value = data.rtpLink || '';
    }
  } catch (_) {
    // ignore
  }
}

async function saveRtpLink() {
  const input = document.getElementById('rtpLinkInput');
  const status = document.getElementById('rtpStatus');
  const link = (input.value || '').trim();
  if (!link) {
    status.textContent = 'Please enter a valid link.';
    status.style.color = '#dc2626';
    return;
  }
  try {
    const res = await fetch('/api/rtp', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rtpLink: link })
    });
    const data = await res.json();
    if (data.success) {
      status.textContent = 'RTP link saved!';
      status.style.color = '#16a34a';
    } else {
      status.textContent = 'Failed to save RTP link: ' + (data.error || 'Unknown error');
      status.style.color = '#dc2626';
    }
  } catch (e) {
    status.textContent = 'Failed to save RTP link: ' + e.message;
    status.style.color = '#dc2626';
  }
}
document.querySelector('[data-tab="settings"]').addEventListener('click', () => {
  switchTab('settings');
  loadSettings();
  // Also load RTP link into the settings UI
  loadRtpLink();
});

// Function to update dashboard stats
async function updateDashboardStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        if (!response.ok) throw new Error('Failed to fetch dashboard stats');
        
        const data = await response.json();
        
        // Update the UI with real data
        document.getElementById('activeUsers').textContent = data.activeUsers || 0;
        document.getElementById('openTickets').textContent = data.openTickets || 0;
        
        // Update promotions count from the actual promotions data
        if (window.promotions) {
            document.getElementById('promotionsCount').textContent = window.promotions.length || 0;
        }
    } catch (error) {
        console.error('Error updating dashboard stats:', error);
    }
}

// Initialize the dashboard when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    refreshTickets();
    fetchPromotions();
    loadSettings();
    updateDashboardStats();
    
    // Update stats every 30 seconds
    setInterval(updateDashboardStats, 30000);
    
    // Start polling for support pings
    pollSupportPings();
});

// Initialize
document.querySelectorAll('.nav-tab').forEach(tab=>tab.addEventListener('click',()=>switchTab(tab.getAttribute('data-tab'))));
// On page load, fetch promotions
fetchPromotions();

// Auto-refresh promotions every 10 seconds
setInterval(() => {
    fetchPromotions();
}, 10000);

// Auto-refresh tickets every 15 seconds (faster polling)
setInterval(() => {
    if (document.querySelector('[data-tab="livechat"]').classList.contains('active')) {
        refreshTickets();
    }
}, 15000);

// Auto-refresh chat history every 5 seconds for the open chat (faster polling)
setInterval(() => {
    if (
        document.querySelector('[data-tab="livechat"]').classList.contains('active') &&
        selectedTicketId
    ) {
        loadChatHistory(selectedTicketId);
    }
}, 5000);

// ---------------- Support Ping Polling ----------------
function ensureToastContainer() {
  let c = document.getElementById('supportPingToasts');
  if (!c) {
    c = document.createElement('div');
    c.id = 'supportPingToasts';
    c.style.position = 'fixed';
    c.style.right = '16px';
    c.style.bottom = '16px';
    c.style.display = 'flex';
    c.style.flexDirection = 'column';
    c.style.gap = '8px';
    c.style.zIndex = '9999';
    document.body.appendChild(c);
  }
  return c;
}

function showSupportPingToast(ping) {
  const c = ensureToastContainer();
  const t = document.createElement('div');
  t.style.background = '#0f172a';
  t.style.color = '#fff';
  t.style.padding = '12px 14px';
  t.style.borderRadius = '8px';
  t.style.boxShadow = '0 4px 14px rgba(0,0,0,0.25)';
  t.style.maxWidth = '320px';
  t.style.fontSize = '14px';
  const title = getPingTitle(ping && ping.type);
  const amountStr = ping && ping.amount ? `<div><strong>Amount:</strong> ${formatAmount(ping.amount)}</div>` : '';
  const msgStr = ping && ping.message ? `<div style="margin-top:4px;opacity:0.9">${ping.message}</div>` : '';
  t.innerHTML = `<div style="font-weight:600;margin-bottom:4px">${title}</div>
    <div><strong>User ID:</strong> ${ping.userId || '-'}</div>
    ${amountStr}
    ${msgStr}
    <div style="margin-top:4px;opacity:0.8">Chat: ${ping.chatId}</div>`;
  // Click to open and highlight chat
  t.style.cursor = 'pointer';
  t.addEventListener('click', () => {
    switchTab('livechat');
    if (ping && ping.chatId) {
      openChat(ping.chatId);
      highlightChat(ping.chatId);
    }
  });
  c.appendChild(t);
  setTimeout(() => { t.remove(); }, 8000);
}

// Map ping type to a readable title with emoji
function getPingTitle(type) {
  switch ((type || '').toLowerCase()) {
    case 'deposit_check': return '🔔 Deposit Check';
    case 'withdraw_check': return '💸 Withdraw Checking';
    case 'password_reset': return '🔑 Password Reset Request';
    case 'account_registration': return '🆕 Account Registration';
    case 'turnover': return '📈 Turnover Inquiry';
    default: return '🔔 Support Notification';
  }
}

function formatAmount(a) {
  try {
    const s = String(a).replace(/rp/ig,'').trim();
    return 'Rp ' + s;
  } catch (_) { return String(a); }
}

// Visually highlight a chat item in the list for quick attention
function highlightChat(chatId) {
  const el = document.getElementById('ticket-' + chatId);
  if (!el) return;
  // Add a temporary highlight style
  el.style.transition = 'box-shadow 0.3s, background 0.3s';
  el.style.boxShadow = '0 0 0 3px #f59e0b';
  el.style.background = 'rgba(245, 158, 11, 0.08)';
  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  setTimeout(() => {
    el.style.boxShadow = '';
    el.style.background = '';
  }, 6000);
}

function updateSupportPingBadge(count) {
  const b = document.getElementById('supportPingBadge');
  if (!b) return;
  if (count && count > 0) {
    b.textContent = String(count);
    b.style.display = 'inline-block';
  } else {
    b.style.display = 'none';
  }
}

async function pollSupportPings() {
  try {
    const res = await fetch('/support-pings');
    const data = await res.json();
    if (!data.success) return;
    const pings = Array.isArray(data.pings) ? data.pings : [];
    if (pings.length > 0) {
      // Play sound and show toast for each
      playPing();
      updateSupportPingBadge(pings.length);
      pings.forEach(p => {
        showSupportPingToast(p);
        // Highlight related chat in list
        if (p && p.chatId) {
          highlightChat(p.chatId);
        }
      });
      // Mark as read to avoid duplicates on next poll
    fetch('/support-pings?markRead=true').catch(()=>{});
    }
  } catch (e) {
    // silent fail; optionally log
    // console.warn('Support ping poll failed', e);
  }
}

// Start polling every 7 seconds
setInterval(pollSupportPings, 7000);
</script>
<!-- LiveChat widget (single authoritative embed) -->
<!-- Start of LiveChat (www.livechat.com) code -->
<script>
    window.__lc = window.__lc || {};
    window.__lc.license = 19291328;
    window.__lc.integration_name = "manual_onboarding";
    window.__lc.product_name = "livechat";
    ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice))
</script>
<noscript><a href="https://www.livechat.com/chat-with/19291328/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code -->
<!-- Chatbot Widget -->
<div id="chatbot-container">
    <div id="chatbot-header" onclick="toggleChat()">
        💬 Chat with us
    </div>
    <div id="chatbot-body">
        <div id="chat-messages"></div>
        <div id="chat-input">
            <input type="text" id="userInput" placeholder="Type your message..." />
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>


<style>
/* Chatbot container */
#chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    font-family: Arial, sans-serif;
    z-index: 1000;
}
/* Header (click to toggle) */
#chatbot-header {
    background: #0A192F; /* Dark navy */
    color: white;
    padding: 12px;
    border-radius: 10px 10px 0 0;
    cursor: pointer;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
/* Body (hidden by default) */
#chatbot-body {
    display: none;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 10px 10px;
    height: 400px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 6px 10px rgba(0,0,0,0.2);
}
/* Messages */
#chat-messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 14px;
}
/* Input */
#chat-input {
    display: flex;
    border-top: 1px solid #ddd;
}
#chat-input input {
    flex: 1;
    border: none;
    padding: 10px;
    font-size: 14px;
}
#chat-input button {
    background: #0A192F;
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: bold;
    border-radius: 0 0 10px 0;
}
#chat-input button:hover {
    background: #133b5c;
}
/* Chat bubbles */
.bot-message {
    background: #f1f1f1;
    padding: 8px;
    border-radius: 10px;
    margin: 5px 0;
}
.user-message {
    background: #0A192F;
    color: white;
    padding: 8px;
    border-radius: 10px;
    margin: 5px 0;
    text-align: right;
}
</style>

<script>
// Chatbot widget logic
function toggleChat() {
    const body = document.getElementById('chatbot-body');
    body.style.display = (body.style.display === 'flex') ? 'none' : 'flex';
}

async function sendMessage() {
    const input = document.getElementById('userInput');
    const msg = input.value.trim();
    if (!msg) return;
    appendMessage(msg, 'user');
    input.value = '';
    // Send to backend
    try {
        const res = await fetch('/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        let reply = data.reply;
        if (typeof reply === 'object') reply = JSON.stringify(reply, null, 2);
        appendMessage(reply, 'bot');
    } catch (e) {
        appendMessage('Sorry, there was an error. Please try again.', 'bot');
    }
}

function appendMessage(text, sender) {
    const messagesDiv = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = sender === 'user' ? 'user-message' : 'bot-message';
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>

</body>

</html>
